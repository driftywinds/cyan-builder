name: Generate Cyan File from Deb

on:
  workflow_dispatch:
    inputs:
      deb_url:
        description: 'Direct link to the .deb tweak file'
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv curl unzip

      - name: Install pipx
        run: |
          python3 -m pip install --user pipx
          python3 -m pipx ensurepath
        env:
          PIPX_HOME: ~/.local/pipx
          PIPX_BIN_DIR: ~/.local/bin

      - name: Add pipx to PATH
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH

      - name: Install cgen (via cyan)
        run: pipx install --force https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip

      - name: Download .deb tweak file
        run: |
          curl -L "${{ github.event.inputs.deb_url }}" -o tweak.deb

      - name: Extract tweak name from URL
        id: extract_name
        run: |
          filename=$(basename "${{ github.event.inputs.deb_url }}")
          tweakname="${filename%.deb}"
          echo "name=$tweakname" >> $GITHUB_OUTPUT

      - name: Generate .cyan file using cgen
        run: |
          cgen -f tweak.deb -uwsgq -o "${{ steps.extract_name.outputs.name }}.cyan"

      - name: Create draft release with cyan file
        uses: ncipollo/release-action@v1
        with:
          tag: cyan-from-${{ steps.extract_name.outputs.name }}
          name: Cyan File for ${{ steps.extract_name.outputs.name }}
          draft: true
          prerelease: false
          artifacts: ${{ steps.extract_name.outputs.name }}.cyan
          token: ${{ secrets.GH_TOKEN }}
